@page "/"
@inject IScoreService ScoreService
@inject ViewportService ViewportService
@implements IDisposable

<div class="game-container">
    <h1 class="game-title">agTetribricks</h1>

    <ScoreBar PreviewPoints="_previewPoints" Score="_controller.TotalScore" />
    <Toolbar CanUndo="_controller.CanUndo"
             CanRedo="_controller.CanRedo"
             OnUndo="HandleUndo"
             OnRedo="HandleRedo"
             OnNewGame="HandleNewGame"
             OnToggleHighScores="ToggleHighScores" />

    <div class="board-container">
        <GameBoard Game="_controller.CurrentGame"
                   TileSize="_gridDimensions.TileSize"
                   IsTouchDevice="_isTouchDevice"
                   OnBrickClick="HandleBrickClick"
                   OnPreviewPoints="HandlePreviewPoints" />

        @if (_showHighScores)
        {
            <HighScoresPanel OnClose="ToggleHighScores" />
        }

        @if (_showSubmitForm)
        {
            <SubmitScoreForm Score="_controller.TotalScore"
                             OnSubmitted="HandleScoreSubmitted"
                             OnCancel="HandleSubmitCancel" />
        }

        @if (_isGameOver && !_showSubmitForm)
        {
            <div class="overlay-panel game-over-panel">
                <h3>Game Over!</h3>
                <p>Final Score: <strong>@_controller.TotalScore</strong></p>
                <button class="toolbar-btn" @onclick="HandleNewGame">New Game</button>
            </div>
        }
    </div>
</div>

@code {
    private TetriBricksGameController _controller = new();
    private GridDimensions _gridDimensions = new(15, 15, 20);
    private bool _isTouchDevice;
    private int _previewPoints;
    private bool _showHighScores;
    private bool _showSubmitForm;
    private bool _isGameOver;
    private int _lowestTopScore;

    protected override async Task OnInitializedAsync()
    {
        await ViewportService.InitializeAsync();
        _isTouchDevice = ViewportService.Current.IsTouchDevice;

        _gridDimensions = GridCalculator.Calculate(
            ViewportService.Current.Width,
            ViewportService.Current.Height,
            _isTouchDevice);

        _controller = new TetriBricksGameController(_gridDimensions.Rows, _gridDimensions.Columns);

        ViewportService.ViewportChanged += OnViewportChanged;

        await LoadLowestTopScore();
    }

    private void OnViewportChanged(ViewportInfo info)
    {
        var newDimensions = GridCalculator.Calculate(info.Width, info.Height, info.IsTouchDevice);
        _isTouchDevice = info.IsTouchDevice;

        if (newDimensions.Rows != _gridDimensions.Rows || newDimensions.Columns != _gridDimensions.Columns)
        {
            _gridDimensions = newDimensions;
            _controller = new TetriBricksGameController(_gridDimensions.Rows, _gridDimensions.Columns);
            _previewPoints = 0;
            _isGameOver = false;
            _showSubmitForm = false;
        }
        else if (newDimensions.TileSize != _gridDimensions.TileSize)
        {
            _gridDimensions = newDimensions;
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task LoadLowestTopScore()
    {
        try
        {
            var scores = await ScoreService.GetTopScoresAsync();
            _lowestTopScore = scores.Count >= 20 ? scores.Min(s => s.ScoreValue) : 0;
        }
        catch
        {
            _lowestTopScore = 0;
        }
    }

    private void HandleBrickClick(Brick brick)
    {
        if (_isGameOver) return;

        _controller.RemoveBrick(brick);
        _previewPoints = 0;

        if (_controller.CurrentGame.IsGameOver)
        {
            _isGameOver = true;
            if (_controller.TotalScore > _lowestTopScore)
            {
                _showSubmitForm = true;
            }
        }
    }

    private void HandlePreviewPoints(int points)
    {
        _previewPoints = points;
    }

    private void HandleUndo()
    {
        _controller.Previous();
        _isGameOver = false;
        _showSubmitForm = false;
    }

    private void HandleRedo()
    {
        _controller.Next();
        if (_controller.CurrentGame.IsGameOver)
        {
            _isGameOver = true;
        }
    }

    private async Task HandleNewGame()
    {
        _controller.CreateNewGame(_gridDimensions.Rows, _gridDimensions.Columns);
        _previewPoints = 0;
        _isGameOver = false;
        _showSubmitForm = false;
        _showHighScores = false;
        await LoadLowestTopScore();
    }

    private void ToggleHighScores()
    {
        _showHighScores = !_showHighScores;
    }

    private async Task HandleScoreSubmitted()
    {
        _showSubmitForm = false;
        await LoadLowestTopScore();
    }

    private void HandleSubmitCancel()
    {
        _showSubmitForm = false;
    }

    public void Dispose()
    {
        ViewportService.ViewportChanged -= OnViewportChanged;
    }
}
